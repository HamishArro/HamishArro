{"ast":null,"code":"import _extends from \"@babel/runtime/helpers/extends\";\nimport _objectWithoutProperties from \"@babel/runtime/helpers/objectWithoutProperties\";\nimport _classCallCheck from \"@babel/runtime/helpers/classCallCheck\";\nimport _createClass from \"@babel/runtime/helpers/createClass\";\nimport _inherits from \"@babel/runtime/helpers/inherits\";\nimport _possibleConstructorReturn from \"@babel/runtime/helpers/possibleConstructorReturn\";\nimport _getPrototypeOf from \"@babel/runtime/helpers/getPrototypeOf\";\nimport _toConsumableArray from \"@babel/runtime/helpers/toConsumableArray\";\nvar _excluded = [\"onContextCreate\", \"onContextRestored\", \"onContextLost\", \"webglContextAttributes\", \"msaaSamples\", \"nativeRef_EXPERIMENTAL\", \"ref\"];\n\nfunction _createSuper(Derived) { var hasNativeReflectConstruct = _isNativeReflectConstruct(); return function _createSuperInternal() { var Super = _getPrototypeOf(Derived), result; if (hasNativeReflectConstruct) { var NewTarget = _getPrototypeOf(this).constructor; result = Reflect.construct(Super, arguments, NewTarget); } else { result = Super.apply(this, arguments); } return _possibleConstructorReturn(this, result); }; }\n\nfunction _isNativeReflectConstruct() { if (typeof Reflect === \"undefined\" || !Reflect.construct) return false; if (Reflect.construct.sham) return false; if (typeof Proxy === \"function\") return true; try { Boolean.prototype.valueOf.call(Reflect.construct(Boolean, [], function () {})); return true; } catch (e) { return false; } }\n\nimport _regeneratorRuntime from \"@babel/runtime/regenerator\";\nimport { CodedError, Platform, UnavailabilityError } from '@unimodules/core';\nimport invariant from 'invariant';\nimport * as React from 'react';\nimport Dimensions from \"react-native-web/dist/exports/Dimensions\";\nimport Canvas from \"./Canvas\";\n\nfunction getImageForAsset(asset) {\n  if (asset != null && typeof asset === 'object' && asset !== null && asset.downloadAsync) {\n    var dataURI = asset.localUri || asset.uri || '';\n    var image = new Image();\n    image.src = dataURI;\n    return image;\n  }\n\n  return asset;\n}\n\nfunction isOffscreenCanvas(element) {\n  return element && typeof element.convertToBlob === 'function';\n}\n\nfunction asExpoContext(gl) {\n  gl.endFrameEXP = function glEndFrameEXP() {};\n\n  if (!gl['_expo_texImage2D']) {\n    gl['_expo_texImage2D'] = gl.texImage2D;\n\n    gl.texImage2D = function () {\n      for (var _len = arguments.length, props = new Array(_len), _key = 0; _key < _len; _key++) {\n        props[_key] = arguments[_key];\n      }\n\n      var nextProps = [].concat(props);\n      nextProps.push(getImageForAsset(nextProps.pop()));\n      return gl['_expo_texImage2D'].apply(gl, _toConsumableArray(nextProps));\n    };\n  }\n\n  if (!gl['_expo_texSubImage2D']) {\n    gl['_expo_texSubImage2D'] = gl.texSubImage2D;\n\n    gl.texSubImage2D = function () {\n      for (var _len2 = arguments.length, props = new Array(_len2), _key2 = 0; _key2 < _len2; _key2++) {\n        props[_key2] = arguments[_key2];\n      }\n\n      var nextProps = [].concat(props);\n      nextProps.push(getImageForAsset(nextProps.pop()));\n      return gl['_expo_texSubImage2D'].apply(gl, _toConsumableArray(nextProps));\n    };\n  }\n\n  return gl;\n}\n\nfunction ensureContext(canvas, contextAttributes) {\n  if (!canvas) {\n    throw new CodedError('ERR_GL_INVALID', 'Attempting to use the GL context before it has been created.');\n  }\n\n  var isIOS = !!navigator.platform && /iPad|iPhone|iPod/.test(navigator.platform);\n  var context = !isIOS && canvas.getContext('webgl2', contextAttributes) || canvas.getContext('webgl', contextAttributes) || canvas.getContext('webgl-experimental', contextAttributes) || canvas.getContext('experimental-webgl', contextAttributes);\n  invariant(context, 'Browser does not support WebGL');\n  return asExpoContext(context);\n}\n\nfunction getBlobFromWebGLRenderingContext(gl) {\n  var options,\n      canvas,\n      blob,\n      _args = arguments;\n  return _regeneratorRuntime.async(function getBlobFromWebGLRenderingContext$(_context) {\n    while (1) {\n      switch (_context.prev = _context.next) {\n        case 0:\n          options = _args.length > 1 && _args[1] !== undefined ? _args[1] : {};\n          invariant(gl, 'getBlobFromWebGLRenderingContext(): WebGL Rendering Context is not defined');\n          canvas = gl.canvas;\n          blob = null;\n\n          if (!(typeof canvas.msToBlob === 'function')) {\n            _context.next = 10;\n            break;\n          }\n\n          _context.next = 7;\n          return _regeneratorRuntime.awrap(canvas.msToBlob());\n\n        case 7:\n          blob = _context.sent;\n          _context.next = 19;\n          break;\n\n        case 10:\n          if (!isOffscreenCanvas(canvas)) {\n            _context.next = 16;\n            break;\n          }\n\n          _context.next = 13;\n          return _regeneratorRuntime.awrap(canvas.convertToBlob({\n            quality: options.compress,\n            type: options.format\n          }));\n\n        case 13:\n          blob = _context.sent;\n          _context.next = 19;\n          break;\n\n        case 16:\n          _context.next = 18;\n          return _regeneratorRuntime.awrap(new Promise(function (resolve) {\n            canvas.toBlob(function (blob) {\n              return resolve(blob);\n            }, options.format, options.compress);\n          }));\n\n        case 18:\n          blob = _context.sent;\n\n        case 19:\n          return _context.abrupt(\"return\", {\n            blob: blob,\n            width: canvas.width,\n            height: canvas.height\n          });\n\n        case 20:\n        case \"end\":\n          return _context.stop();\n      }\n    }\n  }, null, null, null, Promise);\n}\n\nexport var GLView = function (_React$Component) {\n  _inherits(GLView, _React$Component);\n\n  var _super = _createSuper(GLView);\n\n  function GLView() {\n    var _this;\n\n    _classCallCheck(this, GLView);\n\n    _this = _super.apply(this, arguments);\n\n    _this.onContextLost = function (event) {\n      if (event && event.preventDefault) {\n        event.preventDefault();\n      }\n\n      _this.gl = undefined;\n\n      if (typeof _this.props.onContextLost === 'function') {\n        _this.props.onContextLost();\n      }\n    };\n\n    _this.onContextRestored = function () {\n      _this.gl = undefined;\n\n      if (_this.getGLContext() == null) {\n        throw new CodedError('ERR_GL_INVALID', 'Failed to restore GL context.');\n      }\n    };\n\n    _this.setCanvasRef = function (canvas) {\n      _this.canvas = canvas;\n\n      if (typeof _this.props.nativeRef_EXPERIMENTAL === 'function') {\n        _this.props.nativeRef_EXPERIMENTAL(canvas);\n      }\n\n      if (_this.canvas) {\n        _this.canvas.addEventListener('webglcontextlost', _this.onContextLost);\n\n        _this.canvas.addEventListener('webglcontextrestored', _this.onContextRestored);\n\n        _this.getGLContext();\n      }\n    };\n\n    return _this;\n  }\n\n  _createClass(GLView, [{\n    key: \"componentWillUnmount\",\n    value: function componentWillUnmount() {\n      if (this.gl) {\n        var loseContextExt = this.gl.getExtension('WEBGL_lose_context');\n\n        if (loseContextExt) {\n          loseContextExt.loseContext();\n        }\n\n        this.gl = undefined;\n      }\n\n      if (this.canvas) {\n        this.canvas.removeEventListener('webglcontextlost', this.onContextLost);\n        this.canvas.removeEventListener('webglcontextrestored', this.onContextRestored);\n      }\n    }\n  }, {\n    key: \"render\",\n    value: function render() {\n      var _this$props = this.props,\n          onContextCreate = _this$props.onContextCreate,\n          onContextRestored = _this$props.onContextRestored,\n          onContextLost = _this$props.onContextLost,\n          webglContextAttributes = _this$props.webglContextAttributes,\n          msaaSamples = _this$props.msaaSamples,\n          nativeRef_EXPERIMENTAL = _this$props.nativeRef_EXPERIMENTAL,\n          ref = _this$props.ref,\n          domProps = _objectWithoutProperties(_this$props, _excluded);\n\n      return React.createElement(Canvas, _extends({}, domProps, {\n        canvasRef: this.setCanvasRef\n      }));\n    }\n  }, {\n    key: \"componentDidUpdate\",\n    value: function componentDidUpdate(prevProps) {\n      var webglContextAttributes = this.props.webglContextAttributes;\n\n      if (this.canvas && webglContextAttributes !== prevProps.webglContextAttributes) {\n        this.onContextLost(null);\n        this.onContextRestored();\n      }\n    }\n  }, {\n    key: \"getGLContextOrReject\",\n    value: function getGLContextOrReject() {\n      var gl = this.getGLContext();\n\n      if (!gl) {\n        throw new CodedError('ERR_GL_INVALID', 'Attempting to use the GL context before it has been created.');\n      }\n\n      return gl;\n    }\n  }, {\n    key: \"getGLContext\",\n    value: function getGLContext() {\n      if (this.gl) return this.gl;\n\n      if (this.canvas) {\n        this.gl = ensureContext(this.canvas, this.props.webglContextAttributes);\n\n        if (typeof this.props.onContextCreate === 'function') {\n          this.props.onContextCreate(this.gl);\n        }\n\n        return this.gl;\n      }\n\n      return null;\n    }\n  }, {\n    key: \"takeSnapshotAsync\",\n    value: function takeSnapshotAsync() {\n      var options,\n          gl,\n          _args2 = arguments;\n      return _regeneratorRuntime.async(function takeSnapshotAsync$(_context2) {\n        while (1) {\n          switch (_context2.prev = _context2.next) {\n            case 0:\n              options = _args2.length > 0 && _args2[0] !== undefined ? _args2[0] : {};\n\n              if (GLView.takeSnapshotAsync) {\n                _context2.next = 3;\n                break;\n              }\n\n              throw new UnavailabilityError('expo-gl', 'takeSnapshotAsync');\n\n            case 3:\n              gl = this.getGLContextOrReject();\n              _context2.next = 6;\n              return _regeneratorRuntime.awrap(GLView.takeSnapshotAsync(gl, options));\n\n            case 6:\n              return _context2.abrupt(\"return\", _context2.sent);\n\n            case 7:\n            case \"end\":\n              return _context2.stop();\n          }\n        }\n      }, null, this, null, Promise);\n    }\n  }, {\n    key: \"startARSessionAsync\",\n    value: function startARSessionAsync() {\n      return _regeneratorRuntime.async(function startARSessionAsync$(_context3) {\n        while (1) {\n          switch (_context3.prev = _context3.next) {\n            case 0:\n              throw new UnavailabilityError('GLView', 'startARSessionAsync');\n\n            case 1:\n            case \"end\":\n              return _context3.stop();\n          }\n        }\n      }, null, null, null, Promise);\n    }\n  }, {\n    key: \"createCameraTextureAsync\",\n    value: function createCameraTextureAsync() {\n      return _regeneratorRuntime.async(function createCameraTextureAsync$(_context4) {\n        while (1) {\n          switch (_context4.prev = _context4.next) {\n            case 0:\n              throw new UnavailabilityError('GLView', 'createCameraTextureAsync');\n\n            case 1:\n            case \"end\":\n              return _context4.stop();\n          }\n        }\n      }, null, null, null, Promise);\n    }\n  }, {\n    key: \"destroyObjectAsync\",\n    value: function destroyObjectAsync(glObject) {\n      return _regeneratorRuntime.async(function destroyObjectAsync$(_context5) {\n        while (1) {\n          switch (_context5.prev = _context5.next) {\n            case 0:\n              throw new UnavailabilityError('GLView', 'destroyObjectAsync');\n\n            case 1:\n            case \"end\":\n              return _context5.stop();\n          }\n        }\n      }, null, null, null, Promise);\n    }\n  }], [{\n    key: \"createContextAsync\",\n    value: function createContextAsync() {\n      var canvas, _Dimensions$get, width, height, scale;\n\n      return _regeneratorRuntime.async(function createContextAsync$(_context6) {\n        while (1) {\n          switch (_context6.prev = _context6.next) {\n            case 0:\n              if (Platform.isDOMAvailable) {\n                _context6.next = 2;\n                break;\n              }\n\n              return _context6.abrupt(\"return\", null);\n\n            case 2:\n              canvas = document.createElement('canvas');\n              _Dimensions$get = Dimensions.get('window'), width = _Dimensions$get.width, height = _Dimensions$get.height, scale = _Dimensions$get.scale;\n              canvas.width = width * scale;\n              canvas.height = height * scale;\n              return _context6.abrupt(\"return\", ensureContext(canvas));\n\n            case 7:\n            case \"end\":\n              return _context6.stop();\n          }\n        }\n      }, null, null, null, Promise);\n    }\n  }, {\n    key: \"destroyContextAsync\",\n    value: function destroyContextAsync(exgl) {\n      return _regeneratorRuntime.async(function destroyContextAsync$(_context7) {\n        while (1) {\n          switch (_context7.prev = _context7.next) {\n            case 0:\n              return _context7.abrupt(\"return\", true);\n\n            case 1:\n            case \"end\":\n              return _context7.stop();\n          }\n        }\n      }, null, null, null, Promise);\n    }\n  }, {\n    key: \"takeSnapshotAsync\",\n    value: function takeSnapshotAsync(gl) {\n      var options,\n          _await$getBlobFromWeb,\n          blob,\n          width,\n          height,\n          _args8 = arguments;\n\n      return _regeneratorRuntime.async(function takeSnapshotAsync$(_context8) {\n        while (1) {\n          switch (_context8.prev = _context8.next) {\n            case 0:\n              options = _args8.length > 1 && _args8[1] !== undefined ? _args8[1] : {};\n              _context8.next = 3;\n              return _regeneratorRuntime.awrap(getBlobFromWebGLRenderingContext(gl, options));\n\n            case 3:\n              _await$getBlobFromWeb = _context8.sent;\n              blob = _await$getBlobFromWeb.blob;\n              width = _await$getBlobFromWeb.width;\n              height = _await$getBlobFromWeb.height;\n\n              if (blob) {\n                _context8.next = 9;\n                break;\n              }\n\n              throw new CodedError('ERR_GL_SNAPSHOT', 'Failed to save the GL context');\n\n            case 9:\n              return _context8.abrupt(\"return\", {\n                uri: blob,\n                localUri: '',\n                width: width,\n                height: height\n              });\n\n            case 10:\n            case \"end\":\n              return _context8.stop();\n          }\n        }\n      }, null, null, null, Promise);\n    }\n  }]);\n\n  return GLView;\n}(React.Component);","map":{"version":3,"sources":["../src/GLView.web.tsx"],"names":[],"mappings":"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","sourcesContent":["import { CodedError, Platform, UnavailabilityError } from '@unimodules/core';\nimport invariant from 'invariant';\nimport * as React from 'react';\nimport { Dimensions } from 'react-native';\n\nimport Canvas from './Canvas';\nimport {\n  BaseGLViewProps,\n  ComponentOrHandle,\n  ExpoWebGLRenderingContext,\n  GLSnapshot,\n  SnapshotOptions,\n} from './GLView.types';\n\nfunction getImageForAsset(asset: {\n  downloadAsync: () => Promise<any>;\n  uri?: string;\n  localUri?: string;\n}): HTMLImageElement | any {\n  if (asset != null && typeof asset === 'object' && asset !== null && asset.downloadAsync) {\n    const dataURI = asset.localUri || asset.uri || '';\n    const image = new Image();\n    image.src = dataURI;\n    return image;\n  }\n  return asset;\n}\n\nfunction isOffscreenCanvas(element: any): element is OffscreenCanvas {\n  return element && typeof element.convertToBlob === 'function';\n}\n\nfunction asExpoContext(gl: ExpoWebGLRenderingContext): WebGLRenderingContext {\n  gl.endFrameEXP = function glEndFrameEXP(): void {};\n\n  if (!gl['_expo_texImage2D']) {\n    gl['_expo_texImage2D'] = gl.texImage2D;\n    gl.texImage2D = (...props: any[]): any => {\n      const nextProps = [...props];\n      nextProps.push(getImageForAsset(nextProps.pop()));\n      return gl['_expo_texImage2D'](...nextProps);\n    };\n  }\n\n  if (!gl['_expo_texSubImage2D']) {\n    gl['_expo_texSubImage2D'] = gl.texSubImage2D;\n    gl.texSubImage2D = (...props: any[]): any => {\n      const nextProps = [...props];\n      nextProps.push(getImageForAsset(nextProps.pop()));\n      return gl['_expo_texSubImage2D'](...nextProps);\n    };\n  }\n\n  return gl;\n}\n\nfunction ensureContext(\n  canvas?: HTMLCanvasElement,\n  contextAttributes?: WebGLContextAttributes\n): WebGLRenderingContext {\n  if (!canvas) {\n    throw new CodedError(\n      'ERR_GL_INVALID',\n      'Attempting to use the GL context before it has been created.'\n    );\n  }\n\n  // Apple disables WebGL 2.0 and doesn't provide any way to detect if it's disabled.\n  const isIOS = !!navigator.platform && /iPad|iPhone|iPod/.test(navigator.platform);\n\n  const context =\n    (!isIOS && canvas.getContext('webgl2', contextAttributes)) ||\n    canvas.getContext('webgl', contextAttributes) ||\n    canvas.getContext('webgl-experimental', contextAttributes) ||\n    canvas.getContext('experimental-webgl', contextAttributes);\n  invariant(context, 'Browser does not support WebGL');\n  return asExpoContext(context as ExpoWebGLRenderingContext);\n}\n\nexport interface GLViewProps extends BaseGLViewProps {\n  onContextCreate: (gl: WebGLRenderingContext) => void;\n  onContextRestored?: (gl?: WebGLRenderingContext) => void;\n  onContextLost?: () => void;\n  webglContextAttributes?: WebGLContextAttributes;\n  /**\n   * [iOS only] Number of samples for Apple's built-in multisampling.\n   */\n  msaaSamples: number;\n\n  /**\n   * A ref callback for the native GLView\n   */\n  nativeRef_EXPERIMENTAL?(callback: ComponentOrHandle | HTMLCanvasElement | null);\n}\n\nasync function getBlobFromWebGLRenderingContext(\n  gl: WebGLRenderingContext,\n  options: SnapshotOptions = {}\n): Promise<{ width: number; height: number; blob: Blob | null }> {\n  invariant(gl, 'getBlobFromWebGLRenderingContext(): WebGL Rendering Context is not defined');\n\n  const { canvas } = gl;\n\n  let blob: Blob | null = null;\n\n  if (typeof (canvas as any).msToBlob === 'function') {\n    // @ts-ignore: polyfill: https://stackoverflow.com/a/29815058/4047926\n    blob = await canvas.msToBlob();\n  } else if (isOffscreenCanvas(canvas)) {\n    blob = await canvas.convertToBlob({ quality: options.compress, type: options.format });\n  } else {\n    blob = await new Promise(resolve => {\n      canvas.toBlob((blob: Blob | null) => resolve(blob), options.format, options.compress);\n    });\n  }\n\n  return {\n    blob,\n    width: canvas.width,\n    height: canvas.height,\n  };\n}\n\nexport class GLView extends React.Component<GLViewProps> {\n  canvas?: HTMLCanvasElement;\n\n  gl?: WebGLRenderingContext;\n\n  static async createContextAsync(): Promise<WebGLRenderingContext | null> {\n    if (!Platform.isDOMAvailable) {\n      return null;\n    }\n    const canvas = document.createElement('canvas');\n    const { width, height, scale } = Dimensions.get('window');\n    canvas.width = width * scale;\n    canvas.height = height * scale;\n    return ensureContext(canvas);\n  }\n\n  static async destroyContextAsync(exgl?: WebGLRenderingContext | number): Promise<boolean> {\n    // Do nothing\n    return true;\n  }\n\n  static async takeSnapshotAsync(\n    gl: WebGLRenderingContext,\n    options: SnapshotOptions = {}\n  ): Promise<GLSnapshot> {\n    const { blob, width, height } = await getBlobFromWebGLRenderingContext(gl, options);\n\n    if (!blob) {\n      throw new CodedError('ERR_GL_SNAPSHOT', 'Failed to save the GL context');\n    }\n\n    return {\n      uri: blob,\n      localUri: '',\n      width,\n      height,\n    };\n  }\n\n  componentWillUnmount() {\n    if (this.gl) {\n      const loseContextExt = this.gl.getExtension('WEBGL_lose_context');\n      if (loseContextExt) {\n        loseContextExt.loseContext();\n      }\n      this.gl = undefined;\n    }\n    if (this.canvas) {\n      this.canvas.removeEventListener('webglcontextlost', this.onContextLost);\n      this.canvas.removeEventListener('webglcontextrestored', this.onContextRestored);\n    }\n  }\n\n  render() {\n    const {\n      onContextCreate,\n      onContextRestored,\n      onContextLost,\n      webglContextAttributes,\n      msaaSamples,\n      nativeRef_EXPERIMENTAL,\n      // @ts-ignore: ref does not exist\n      ref,\n      ...domProps\n    } = this.props;\n\n    return <Canvas {...domProps} canvasRef={this.setCanvasRef} />;\n  }\n\n  componentDidUpdate(prevProps: GLViewProps) {\n    const { webglContextAttributes } = this.props;\n    if (this.canvas && webglContextAttributes !== prevProps.webglContextAttributes) {\n      this.onContextLost(null);\n      this.onContextRestored();\n    }\n  }\n\n  private getGLContextOrReject(): WebGLRenderingContext {\n    const gl = this.getGLContext();\n    if (!gl) {\n      throw new CodedError(\n        'ERR_GL_INVALID',\n        'Attempting to use the GL context before it has been created.'\n      );\n    }\n    return gl;\n  }\n\n  private onContextLost = (event: Event | null): void => {\n    if (event && event.preventDefault) {\n      event.preventDefault();\n    }\n    this.gl = undefined;\n\n    if (typeof this.props.onContextLost === 'function') {\n      this.props.onContextLost();\n    }\n  };\n\n  private onContextRestored = (): void => {\n    this.gl = undefined;\n    if (this.getGLContext() == null) {\n      throw new CodedError('ERR_GL_INVALID', 'Failed to restore GL context.');\n    }\n  };\n\n  private getGLContext(): WebGLRenderingContext | null {\n    if (this.gl) return this.gl;\n\n    if (this.canvas) {\n      this.gl = ensureContext(this.canvas, this.props.webglContextAttributes);\n      if (typeof this.props.onContextCreate === 'function') {\n        this.props.onContextCreate(this.gl);\n      }\n      return this.gl;\n    }\n    return null;\n  }\n\n  private setCanvasRef = (canvas: HTMLCanvasElement): void => {\n    this.canvas = canvas;\n\n    if (typeof this.props.nativeRef_EXPERIMENTAL === 'function') {\n      this.props.nativeRef_EXPERIMENTAL(canvas);\n    }\n\n    if (this.canvas) {\n      this.canvas.addEventListener('webglcontextlost', this.onContextLost);\n      this.canvas.addEventListener('webglcontextrestored', this.onContextRestored);\n\n      this.getGLContext();\n    }\n  };\n\n  public async takeSnapshotAsync(options: SnapshotOptions = {}): Promise<GLSnapshot> {\n    if (!GLView.takeSnapshotAsync) {\n      throw new UnavailabilityError('expo-gl', 'takeSnapshotAsync');\n    }\n\n    const gl = this.getGLContextOrReject();\n    return await GLView.takeSnapshotAsync(gl, options);\n  }\n\n  public async startARSessionAsync(): Promise<void> {\n    throw new UnavailabilityError('GLView', 'startARSessionAsync');\n  }\n\n  public async createCameraTextureAsync(): Promise<void> {\n    throw new UnavailabilityError('GLView', 'createCameraTextureAsync');\n  }\n\n  public async destroyObjectAsync(glObject: WebGLObject): Promise<void> {\n    throw new UnavailabilityError('GLView', 'destroyObjectAsync');\n  }\n}\n"],"sourceRoot":""},"metadata":{},"sourceType":"module"}